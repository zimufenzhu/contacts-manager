name: Build APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Install system dependencies with retry
      run: |
        # 更新包列表
        sudo apt update
        
        # 安装基本构建工具
        for i in {1..3}; do
          echo "Attempt $i to install build tools"
          if sudo apt install -y build-essential libgl1-mesa-dev libgles2-mesa-dev && break; then
            echo "Build tools installed successfully"
            break
          else
            echo "Failed to install build tools, attempt $i"
            if [ $i -eq 3 ]; then
              echo "Failed to install build tools after 3 attempts"
              exit 1
            fi
            sleep 5
          fi
        done
        
        # 安装Java和其他依赖
        for i in {1..3}; do
          echo "Attempt $i to install Java and other dependencies"
          if sudo apt install -y git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo6 cmake libffi-dev libssl-dev && break; then
            echo "Java and other dependencies installed successfully"
            break
          else
            echo "Failed to install Java and other dependencies, attempt $i"
            if [ $i -eq 3 ]; then
              echo "Failed to install Java and other dependencies after 3 attempts"
              exit 1
            fi
            sleep 5
          fi
        done

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install Android SDK and Accept Licenses
      run: |
        # 下载并安装Android SDK命令行工具
        cd ~
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip commandlinetools-linux-9477386_latest.zip
        mkdir -p android-sdk/cmdline-tools/latest
        # Move contents of cmdline-tools to the correct location
        mv cmdline-tools/* android-sdk/cmdline-tools/latest/
        
        # Also create the legacy directory structure that buildozer might expect
        mkdir -p android-sdk/tools
        # Copy files instead of creating symbolic links to avoid conflicts
        cp -r android-sdk/cmdline-tools/latest/* android-sdk/tools/
        
        export ANDROID_HOME=$HOME/android-sdk
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
        
        # 验证Android SDK安装
        echo "ANDROID_HOME is set to: $ANDROID_HOME"
        echo "PATH is set to: $PATH"
        ls -la $ANDROID_HOME/
        ls -la $ANDROID_HOME/cmdline-tools/latest/
        
        # 接受所有Android SDK许可证
        echo "Accepting Android SDK licenses..."
        yes | sdkmanager --licenses || true
        
        # 安装必要的构建工具
        echo "Installing Android build tools..."
        sdkmanager "build-tools;34.0.0" "platforms;android-34" "platform-tools" || true
        
        # 验证sdkmanager是否正常工作
        echo "Verifying sdkmanager..."
        sdkmanager --list_installed || true
        
        # 将Android SDK路径设置为环境变量供后续步骤使用
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
        echo "$ANDROID_HOME/build-tools/34.0.0" >> $GITHUB_PATH

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # 为cython安装增加重试机制
        for i in {1..3}; do
          echo "Attempt $i to install cython"
          if pip install --upgrade cython && break; then
            echo "Cython installed successfully"
            break
          else
            echo "Failed to install cython, attempt $i"
            if [ $i -eq 3 ]; then
              echo "Failed to install cython after 3 attempts"
              exit 1
            fi
            sleep 5
          fi
        done
        
        # 为项目依赖增加重试机制
        for i in {1..3}; do
          echo "Attempt $i to install project requirements"
          if pip install -r requirements.txt && break; then
            echo "Project requirements installed successfully"
            break
          else
            echo "Failed to install project requirements, attempt $i"
            if [ $i -eq 3 ]; then
              echo "Failed to install project requirements after 3 attempts"
              exit 1
            fi
            sleep 5
          fi
        done
        
        # 为buildozer增加重试机制
        for i in {1..3}; do
          echo "Attempt $i to install buildozer"
          if pip install buildozer && break; then
            echo "Buildozer installed successfully"
            break
          else
            echo "Failed to install buildozer, attempt $i"
            if [ $i -eq 3 ]; then
              echo "Failed to install buildozer after 3 attempts"
              exit 1
            fi
            sleep 5
          fi
        done

    - name: Configure Buildozer for Android SDK
      run: |
        # 如果buildozer.spec文件存在，则更新其中的SDK路径配置
        if [ -f "buildozer.spec" ]; then
          # 设置Android SDK路径
          sed -i 's|#android.sdk_path =|android.sdk_path = ${HOME}/android-sdk|g' buildozer.spec || echo "Could not set android.sdk_path"
        fi

    - name: Build APK
      run: |
        # 显示环境变量以进行调试
        echo "Environment variables:"
        env | grep -i android || true
        echo "PATH: $PATH"
        
        # 显示当前目录结构
        echo "Current directory structure:"
        ls -la
        
        # 显示buildozer配置
        echo "Buildozer config:"
        cat buildozer.spec || true
        
        # 检查Android SDK路径是否存在
        echo "Checking Android SDK path..."
        if [ -d "$ANDROID_HOME" ]; then
          echo "Android SDK directory exists: $ANDROID_HOME"
          ls -la $ANDROID_HOME/
        else
          echo "ERROR: Android SDK directory does not exist: $ANDROID_HOME"
          exit 1
        fi
        
        # 检查必要的工具是否存在
        echo "Checking for necessary tools..."
        which sdkmanager || echo "sdkmanager not found"
        which adb || echo "adb not found"
        
        # 构建APK
        echo "Building APK..."
        buildozer -v android debug
        
        # 如果构建失败，显示更多调试信息
        if [ $? -ne 0 ]; then
          echo "Build failed. Showing debug information..."
          echo "Buildozer logs:"
          find .buildozer -name "*.log" -exec cat {} \; 2>/dev/null || echo "No log files found"
          exit 1
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: contactsmanager-apk
        path: bin/*.apk
        
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: .buildozer/