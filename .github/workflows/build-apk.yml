name: Build APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Install system dependencies with retry
      run: |
        # 更新包列表
        sudo apt update
        
        # 安装基本构建工具
        for i in {1..3}; do
          echo "Attempt $i to install build tools"
          if sudo apt install -y build-essential libgl1-mesa-dev libgles2-mesa-dev && break; then
            echo "Build tools installed successfully"
            break
          else
            echo "Failed to install build tools, attempt $i"
            if [ $i -eq 3 ]; then
              echo "Failed to install build tools after 3 attempts"
              exit 1
            fi
            sleep 5
          fi
        done
        
        # 安装Java和其他依赖
        for i in {1..3}; do
          echo "Attempt $i to install Java and other dependencies"
          if sudo apt install -y git zip unzip openjdk-13-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev && break; then
            echo "Java and other dependencies installed successfully"
            break
          else
            echo "Failed to install Java and other dependencies, attempt $i"
            if [ $i -eq 3 ]; then
              echo "Failed to install Java and other dependencies after 3 attempts"
              exit 1
            fi
            sleep 5
          fi
        done

    - name: Set up JDK 13
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '13'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # 为cython安装增加重试机制
        for i in {1..3}; do
          echo "Attempt $i to install cython"
          if pip install --upgrade cython && break; then
            echo "Cython installed successfully"
            break
          else
            echo "Failed to install cython, attempt $i"
            if [ $i -eq 3 ]; then
              echo "Failed to install cython after 3 attempts"
              exit 1
            fi
            sleep 5
          fi
        done
        
        # 为项目依赖增加重试机制
        for i in {1..3}; do
          echo "Attempt $i to install project requirements"
          if pip install -r requirements.txt && break; then
            echo "Project requirements installed successfully"
            break
          else
            echo "Failed to install project requirements, attempt $i"
            if [ $i -eq 3 ]; then
              echo "Failed to install project requirements after 3 attempts"
              exit 1
            fi
            sleep 5
          fi
        done
        
        # 为buildozer增加重试机制
        for i in {1..3}; do
          echo "Attempt $i to install buildozer"
          if pip install buildozer && break; then
            echo "Buildozer installed successfully"
            break
          else
            echo "Failed to install buildozer, attempt $i"
            if [ $i -eq 3 ]; then
              echo "Failed to install buildozer after 3 attempts"
              exit 1
            fi
            sleep 5
          fi
        done

    - name: Build APK
      run: |
        buildozer init
        buildozer android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: contactsmanager-apk
        path: bin/*.apk
        
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: .buildozer/